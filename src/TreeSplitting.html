<!DOCTYPE html>
<HTML lang = "en">
<HEAD>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  
  

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: { equationNumbers: { autoNumber: "AMS" } }
    });
  </script>

  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  <style type="text/css">
  @font-face {
  font-style: normal;
  font-weight: 300;
}
@font-face {
  font-style: normal;
  font-weight: 400;
}
@font-face {
  font-style: normal;
  font-weight: 600;
}
html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}
body {
  margin: 0;
}
article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
menu,
nav,
section,
summary {
  display: block;
}
audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}
audio:not([controls]) {
  display: none;
  height: 0;
}
[hidden],
template {
  display: none;
}
a:active,
a:hover {
  outline: 0;
}
abbr[title] {
  border-bottom: 1px dotted;
}
b,
strong {
  font-weight: bold;
}
dfn {
  font-style: italic;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
mark {
  background: #ff0;
  color: #000;
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 1em 40px;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
pre {
  overflow: auto;
}
code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}
button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}
button {
  overflow: visible;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}
button[disabled],
html input[disabled] {
  cursor: default;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
input {
  line-height: normal;
}
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}
input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box; /* 2 */
  box-sizing: content-box;
}
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}
textarea {
  overflow: auto;
}
optgroup {
  font-weight: bold;
}
table {
  font-family: monospace, monospace;
  font-size : 0.8em;
  border-collapse: collapse;
  border-spacing: 0;
}
td,
th {
  padding: 0;
}
thead th {
    border-bottom: 1px solid black;
    background-color: white;
}
tr:nth-child(odd){
  background-color: rgb(248,248,248);
}


/*
* Skeleton V2.0.4
* Copyright 2014, Dave Gamache
* www.getskeleton.com
* Free to use under the MIT license.
* http://www.opensource.org/licenses/mit-license.php
* 12/29/2014
*/
.container {
  position: relative;
  width: 100%;
  max-width: 960px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box; }
.column,
.columns {
  width: 100%;
  float: left;
  box-sizing: border-box; }
@media (min-width: 400px) {
  .container {
    width: 85%;
    padding: 0; }
}
@media (min-width: 550px) {
  .container {
    width: 80%; }
  .column,
  .columns {
    margin-left: 4%; }
  .column:first-child,
  .columns:first-child {
    margin-left: 0; }

  .one.column,
  .one.columns                    { width: 4.66666666667%; }
  .two.columns                    { width: 13.3333333333%; }
  .three.columns                  { width: 22%;            }
  .four.columns                   { width: 30.6666666667%; }
  .five.columns                   { width: 39.3333333333%; }
  .six.columns                    { width: 48%;            }
  .seven.columns                  { width: 56.6666666667%; }
  .eight.columns                  { width: 65.3333333333%; }
  .nine.columns                   { width: 74.0%;          }
  .ten.columns                    { width: 82.6666666667%; }
  .eleven.columns                 { width: 91.3333333333%; }
  .twelve.columns                 { width: 100%; margin-left: 0; }

  .one-third.column               { width: 30.6666666667%; }
  .two-thirds.column              { width: 65.3333333333%; }

  .one-half.column                { width: 48%; }

  /* Offsets */
  .offset-by-one.column,
  .offset-by-one.columns          { margin-left: 8.66666666667%; }
  .offset-by-two.column,
  .offset-by-two.columns          { margin-left: 17.3333333333%; }
  .offset-by-three.column,
  .offset-by-three.columns        { margin-left: 26%;            }
  .offset-by-four.column,
  .offset-by-four.columns         { margin-left: 34.6666666667%; }
  .offset-by-five.column,
  .offset-by-five.columns         { margin-left: 43.3333333333%; }
  .offset-by-six.column,
  .offset-by-six.columns          { margin-left: 52%;            }
  .offset-by-seven.column,
  .offset-by-seven.columns        { margin-left: 60.6666666667%; }
  .offset-by-eight.column,
  .offset-by-eight.columns        { margin-left: 69.3333333333%; }
  .offset-by-nine.column,
  .offset-by-nine.columns         { margin-left: 78.0%;          }
  .offset-by-ten.column,
  .offset-by-ten.columns          { margin-left: 86.6666666667%; }
  .offset-by-eleven.column,
  .offset-by-eleven.columns       { margin-left: 95.3333333333%; }

  .offset-by-one-third.column,
  .offset-by-one-third.columns    { margin-left: 34.6666666667%; }
  .offset-by-two-thirds.column,
  .offset-by-two-thirds.columns   { margin-left: 69.3333333333%; }

  .offset-by-one-half.column,
  .offset-by-one-half.columns     { margin-left: 52%; }

}
html {
  font-size: 62.5%; }
body {
  font-size: 1.5em; /* currently ems cause chrome bug misinterpreting rems on body element */
  line-height: 1.6;
  font-weight: 400;
  font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
  color: #222; }
h1, h2, h3, h4, h5, h6 {
  margin-top: 0;
  margin-bottom: 2rem;
  font-weight: 300; }
h1 { font-size: 3.6rem; line-height: 1.2;  letter-spacing: -.1rem;}
h2 { font-size: 3.4rem; line-height: 1.25; letter-spacing: -.1rem; }
h3 { font-size: 3.2rem; line-height: 1.3;  letter-spacing: -.1rem; }
h4 { font-size: 2.8rem; line-height: 1.35; letter-spacing: -.08rem; }
h5 { font-size: 2.4rem; line-height: 1.5;  letter-spacing: -.05rem; }
h6 { font-size: 1.5rem; line-height: 1.6;  letter-spacing: 0; }

p {
  margin-top: 0; }
a {
  color: #1EAEDB; }
a:hover {
  color: #0FA0CE; }
.button,
button,
input[type="submit"],
input[type="reset"],
input[type="button"] {
  display: inline-block;
  height: 38px;
  padding: 0 30px;
  color: #555;
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  line-height: 38px;
  letter-spacing: .1rem;
  text-transform: uppercase;
  text-decoration: none;
  white-space: nowrap;
  background-color: transparent;
  border-radius: 4px;
  border: 1px solid #bbb;
  cursor: pointer;
  box-sizing: border-box; }
.button:hover,
button:hover,
input[type="submit"]:hover,
input[type="reset"]:hover,
input[type="button"]:hover,
.button:focus,
button:focus,
input[type="submit"]:focus,
input[type="reset"]:focus,
input[type="button"]:focus {
  color: #333;
  border-color: #888;
  outline: 0; }
.button.button-primary,
button.button-primary,
input[type="submit"].button-primary,
input[type="reset"].button-primary,
input[type="button"].button-primary {
  color: #FFF;
  background-color: #33C3F0;
  border-color: #33C3F0; }
.button.button-primary:hover,
button.button-primary:hover,
input[type="submit"].button-primary:hover,
input[type="reset"].button-primary:hover,
input[type="button"].button-primary:hover,
.button.button-primary:focus,
button.button-primary:focus,
input[type="submit"].button-primary:focus,
input[type="reset"].button-primary:focus,
input[type="button"].button-primary:focus {
  color: #FFF;
  background-color: #1EAEDB;
  border-color: #1EAEDB; }
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea,
select {
  height: 38px;
  padding: 6px 10px; /* The 6px vertically centers text on FF, ignored by Webkit */
  background-color: #fff;
  border: 1px solid #D1D1D1;
  border-radius: 4px;
  box-shadow: none;
  box-sizing: border-box; }
/* Removes awkward default styles on some inputs for iOS */
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea {
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none; }
textarea {
  min-height: 65px;
  padding-top: 6px;
  padding-bottom: 6px; }
input[type="email"]:focus,
input[type="number"]:focus,
input[type="search"]:focus,
input[type="text"]:focus,
input[type="tel"]:focus,
input[type="url"]:focus,
input[type="password"]:focus,
textarea:focus,
select:focus {
  border: 1px solid #33C3F0;
  outline: 0; }
label,
legend {
  display: block;
  margin-bottom: .5rem;
  font-weight: 600; }
fieldset {
  padding: 0;
  border-width: 0; }
input[type="checkbox"],
input[type="radio"] {
  display: inline; }
label > .label-body {
  display: inline-block;
  margin-left: .5rem;
  font-weight: normal; }
ul {
  list-style: circle; }
ol {
  list-style: decimal; }
ul ul,
ul ol,
ol ol,
ol ul {
  margin: 1.5rem 0 1.5rem 3rem;
  font-size: 90%; }
li {
  margin-bottom: 1rem; }
th,
td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #E1E1E1; }
th:first-child,
td:first-child {
  padding-left: 0; }
th:last-child,
td:last-child {
  padding-right: 0; }
button,
.button {
  margin-bottom: 1rem; }
input,
textarea,
select,
fieldset {
  margin-bottom: 1.5rem; }
pre,
blockquote,
dl,
figure,
table,
p,
ul,
ol,
form {
  margin-bottom: 2.5rem; }
.u-full-width {
  width: 100%;
  box-sizing: border-box; }
.u-max-full-width {
  max-width: 100%;
  box-sizing: border-box; }
.u-pull-right {
  float: right; }
.u-pull-left {
  float: left; }
hr {
  margin-top: 3rem;
  margin-bottom: 3.5rem;
  border-width: 0;
  border-top: 1px solid #E1E1E1; }
.container:after,
.row:after,
.u-cf {
  content: "";
  display: table;
  clear: both; }

pre {
  display: block;
  padding: 9.5px;
  margin: 0 0 10px;
  font-size: 13px;
  line-height: 1.42857143;
  color: #333;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #ffffff;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre.sourceCode.julia {
  display: block;
  padding: 9.5px;
  margin: 0 0 10px;
  font-size: 13px;
  line-height: 1.42857143;
  color: #333;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre.julia-error {
  color : red
}

code,
kbd,
pre,
samp {
  font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
}
code {
  padding: 2px 4px;
  font-size: 90%;

  background-color: #ffffff;
  border-radius: 4px;
}

@media (min-width: 400px) {}
@media (min-width: 550px) {}
@media (min-width: 750px) {}
@media (min-width: 1000px) {}
@media (min-width: 1200px) {}

h1.title {margin-top : 20px}
img {max-width : 100%}
div.title {text-align: center;}

  </style>

  
<style>
pre.hljl {
    border: 1px solid #ccc;
    margin: 5px;
    padding: 5px;
    overflow-x: auto;
    color: rgb(68,68,68); background-color: rgb(251,251,251); }
pre.hljl > span.hljl-t { }
pre.hljl > span.hljl-w { }
pre.hljl > span.hljl-e { }
pre.hljl > span.hljl-eB { }
pre.hljl > span.hljl-o { }
pre.hljl > span.hljl-k { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kc { color: rgb(59,151,46); font-style: italic; }
pre.hljl > span.hljl-kd { color: rgb(214,102,97); font-style: italic; }
pre.hljl > span.hljl-kn { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kp { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kr { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kt { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-n { }
pre.hljl > span.hljl-na { }
pre.hljl > span.hljl-nb { }
pre.hljl > span.hljl-nbp { }
pre.hljl > span.hljl-nc { }
pre.hljl > span.hljl-ncB { }
pre.hljl > span.hljl-nd { color: rgb(214,102,97); }
pre.hljl > span.hljl-ne { }
pre.hljl > span.hljl-neB { }
pre.hljl > span.hljl-nf { color: rgb(66,102,213); }
pre.hljl > span.hljl-nfm { color: rgb(66,102,213); }
pre.hljl > span.hljl-np { }
pre.hljl > span.hljl-nl { }
pre.hljl > span.hljl-nn { }
pre.hljl > span.hljl-no { }
pre.hljl > span.hljl-nt { }
pre.hljl > span.hljl-nv { }
pre.hljl > span.hljl-nvc { }
pre.hljl > span.hljl-nvg { }
pre.hljl > span.hljl-nvi { }
pre.hljl > span.hljl-nvm { }
pre.hljl > span.hljl-l { }
pre.hljl > span.hljl-ld { color: rgb(148,91,176); font-style: italic; }
pre.hljl > span.hljl-s { color: rgb(201,61,57); }
pre.hljl > span.hljl-sa { color: rgb(201,61,57); }
pre.hljl > span.hljl-sb { color: rgb(201,61,57); }
pre.hljl > span.hljl-sc { color: rgb(201,61,57); }
pre.hljl > span.hljl-sd { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdB { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdC { color: rgb(201,61,57); }
pre.hljl > span.hljl-se { color: rgb(59,151,46); }
pre.hljl > span.hljl-sh { color: rgb(201,61,57); }
pre.hljl > span.hljl-si { }
pre.hljl > span.hljl-so { color: rgb(201,61,57); }
pre.hljl > span.hljl-sr { color: rgb(201,61,57); }
pre.hljl > span.hljl-ss { color: rgb(201,61,57); }
pre.hljl > span.hljl-ssB { color: rgb(201,61,57); }
pre.hljl > span.hljl-nB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nbB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nfB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nh { color: rgb(59,151,46); }
pre.hljl > span.hljl-ni { color: rgb(59,151,46); }
pre.hljl > span.hljl-nil { color: rgb(59,151,46); }
pre.hljl > span.hljl-noB { color: rgb(59,151,46); }
pre.hljl > span.hljl-oB { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-ow { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-p { }
pre.hljl > span.hljl-c { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-ch { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cm { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cp { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cpB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cs { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-csB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-g { }
pre.hljl > span.hljl-gd { }
pre.hljl > span.hljl-ge { }
pre.hljl > span.hljl-geB { }
pre.hljl > span.hljl-gh { }
pre.hljl > span.hljl-gi { }
pre.hljl > span.hljl-go { }
pre.hljl > span.hljl-gp { }
pre.hljl > span.hljl-gs { }
pre.hljl > span.hljl-gsB { }
pre.hljl > span.hljl-gt { }
</style>



</HEAD>
  <BODY>
    <div class ="container">
      <div class = "row">
        <div class = "col-md-12 twelve columns">

          <div class="title">
            
            
            
          </div>

          <h1>Efficient random splits in labelled trees</h1>
<p>During an implemenation of genetic programming over decision trees, I encountered an interesting problem: how to implementa a purely functional way of randomly splitting trees?  By that, I mean a function <code>randomsplit</code>, such that <code>randomsplit&#40;f, t&#41;</code> returns a tuple <code>&#40;t′, s&#41;</code>, where <code>s</code> is a random subtree of <code>t</code>, and <code>t′</code> is <code>t</code> with <code>s</code> replaced by <code>f&#40;s&#41;</code> &#40;i.e., the “new” tree and the old subtree&#41;.</p>
<h2>Preparations</h2>
<p>Assume we have the following definition of binary trees, with labelled leaves:</p>


<pre class='hljl'>
<span class='hljl-k'>abstract type</span><span class='hljl-t'> </span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;:</span><span class='hljl-t'> </span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>label</span><span class='hljl-oB'>::</span><span class='hljl-n'>Int</span><span class='hljl-t'>
    
    </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}(</span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;=</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;=</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>?</span><span class='hljl-t'> </span><span class='hljl-nf'>new</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}(</span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>:</span><span class='hljl-t'> </span><span class='hljl-nf'>error</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Illegal construction&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>Branch</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;:</span><span class='hljl-t'> </span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>left</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>right</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>The type parameter <code>N</code> constrains the range of labels &#40;for the decision trees, <code>N</code> was the number of decision variables&#41;.</p>
<p>First, some pretty printing function for this kind of tree:</p>


<pre class='hljl'>
<span class='hljl-k'>import</span><span class='hljl-t'> </span><span class='hljl-n'>Base</span><span class='hljl-oB'>:</span><span class='hljl-t'> </span><span class='hljl-n'>show</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>show</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-oB'>::</span><span class='hljl-n'>IO</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>l</span><span class='hljl-oB'>::</span><span class='hljl-n'>Leaf</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>indent</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-ni'>0</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot; &quot;</span><span class='hljl-t'> </span><span class='hljl-oB'>^</span><span class='hljl-t'> </span><span class='hljl-n'>indent</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;Leaf(</span><span class='hljl-si'>$</span><span class='hljl-p'>(</span><span class='hljl-n'>l</span><span class='hljl-oB'>.</span><span class='hljl-n'>label</span><span class='hljl-p'>)</span><span class='hljl-s'>)&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>show</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-oB'>::</span><span class='hljl-n'>IO</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-oB'>::</span><span class='hljl-n'>Branch</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>indent</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-ni'>0</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot; &quot;</span><span class='hljl-t'> </span><span class='hljl-oB'>^</span><span class='hljl-t'> </span><span class='hljl-n'>indent</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;Branch(</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>show</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-oB'>.</span><span class='hljl-n'>left</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>indent</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;,</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>show</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-oB'>.</span><span class='hljl-n'>right</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>indent</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-n'>io</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;)&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>Now we can look at some examples:</p>


<pre class='hljl'>
<span class='hljl-kd'>const</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Branch</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-ni'>1</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-ni'>2</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-ni'>4</span><span class='hljl-p'>))</span>
</pre>


<pre class="hljl">
Branch&#40;
  Branch&#40;
    Leaf&#40;1&#41;,
    Leaf&#40;2&#41;&#41;,
  Leaf&#40;4&#41;&#41;
</pre>



<pre class='hljl'>
<span class='hljl-kd'>const</span><span class='hljl-t'> </span><span class='hljl-n'>t2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Branch</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-ni'>1</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-ni'>2</span><span class='hljl-p'>))</span>
</pre>


<pre class="hljl">
Branch&#40;
  Leaf&#40;1&#41;,
  Leaf&#40;2&#41;&#41;
</pre>


<p>I also <a href="boltzmannsampler.jl">implemented</a> sampling of random trees using a <a href="https://byorgey.wordpress.com/2013/04/25/random-binary-trees-with-a-size-limited-critical-boltzmann-sampler-2/">Boltzmann sampler</a>, which generates trees of an expected size in a certain range.</p>



<pre class='hljl'>
<span class='hljl-n'>tlarge</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>(</span><span class='hljl-nf'>BoltzmannSampler</span><span class='hljl-p'>{</span><span class='hljl-ni'>4</span><span class='hljl-p'>}(</span><span class='hljl-ni'>10</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>20</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-nf'>println</span><span class='hljl-p'>(</span><span class='hljl-n'>tlarge</span><span class='hljl-p'>)</span>
</pre>


<pre class="hljl">
Branch&#40;
  Leaf&#40;1&#41;,
  Branch&#40;
    Branch&#40;
      Leaf&#40;4&#41;,
      Leaf&#40;3&#41;&#41;,
    Branch&#40;
      Branch&#40;
        Branch&#40;
          Leaf&#40;2&#41;,
          Leaf&#40;2&#41;&#41;,
        Leaf&#40;2&#41;&#41;,
      Leaf&#40;3&#41;&#41;&#41;&#41;
</pre>


<h2>Naive splitting</h2>
<p>The idea to select and change a random sub-tree is to use <a href="https://stackoverflow.com/a/3272490/1346276">reservoir sampling</a> of continuations.  That is, we iterate over all nodes in the tree, and at each <span class="math">$n$</span>th node, select with probability <span class="math">$1/n$</span> a function which knows how to change the current node &#40;and return the original&#41;.  In the example <code>t2</code> from above, this would in principle be the following functions:</p>



<pre class='hljl'>
<span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-nf'>k</span><span class='hljl-p'>(</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>2</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>k</span><span class='hljl-p'>(</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>2</span><span class='hljl-p'>))),</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>2</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>k</span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>2</span><span class='hljl-p'>))),</span><span class='hljl-t'> </span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>2</span><span class='hljl-p'>)))</span>
</pre>


<p>We call this function the “continuation” at the node.  To efficiently preserve the knowledge about tree structure while recursively traversing it, we also remember at each step the “context” – a function building up the tree to the current point.  The contexts of <code>t2</code> are</p>



<pre class='hljl'>
<span class='hljl-n'>t</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>2</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>t</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>t</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-n'>t</span>
</pre>


<p>Now the continuation at each node <code>t</code>, given <code>context</code>, can locally be defined as</p>



<pre class='hljl'>
<span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-nf'>k</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>)</span>
</pre>


<p>The following functions implement this technique, using anonymous functions for contexts and continuations:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplitnaive_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>l</span><span class='hljl-oB'>::</span><span class='hljl-n'>Leaf</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>context</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>+=</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'>
    </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-oB'>≤</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-n'>n</span><span class='hljl-t'>
        </span><span class='hljl-n'>continuation</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-nf'>k</span><span class='hljl-p'>(</span><span class='hljl-n'>l</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>l</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplitnaive_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-oB'>::</span><span class='hljl-n'>Branch</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>context</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>continuation</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplitnaive_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-oB'>.</span><span class='hljl-n'>left</span><span class='hljl-p'>,</span><span class='hljl-t'> 
                                            </span><span class='hljl-n'>n</span><span class='hljl-p'>,</span><span class='hljl-t'>
                                            </span><span class='hljl-n'>t</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-oB'>.</span><span class='hljl-n'>right</span><span class='hljl-p'>)),</span><span class='hljl-t'>
                                            </span><span class='hljl-n'>continuation</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>continuation</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplitnaive_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-oB'>.</span><span class='hljl-n'>right</span><span class='hljl-p'>,</span><span class='hljl-t'> 
                                            </span><span class='hljl-n'>n</span><span class='hljl-p'>,</span><span class='hljl-t'>
                                            </span><span class='hljl-n'>t</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-oB'>.</span><span class='hljl-n'>left</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>)),</span><span class='hljl-t'>
                                            </span><span class='hljl-n'>continuation</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>+=</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'>
    </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-oB'>≤</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-n'>n</span><span class='hljl-t'>
        </span><span class='hljl-n'>continuation</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-nf'>k</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
    
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>With these internal implementations, we can define the following function for the user, which works by calling the sampled continuation on a provided <code>action</code>:</p>


<pre class='hljl'>
<span class='hljl-s'>&quot;&quot;&quot;
    randomsplitnaive(action, t::Tree)
Select uniformly at random a subtree `s` of `t`, then replace `s` by `action(s)`. 
Returns both the new tree and the replaced subtree.
&quot;&quot;&quot;</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplitnaive</span><span class='hljl-p'>(</span><span class='hljl-n'>action</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-n'>Tree</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-cs'># The continuation argument will be assigned a default with probability 1 on the first leaf,</span><span class='hljl-t'>
    </span><span class='hljl-cs'># so passing `nothing` is safe here.</span><span class='hljl-t'>
    </span><span class='hljl-n'>cont</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>_</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplitnaive_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>identity</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>nothing</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>cont</span><span class='hljl-p'>(</span><span class='hljl-n'>action</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>Given this, we can define a trivial variant ignoring the substitution and just returning the &#40;now randomly sampled&#41; subtree:</p>


<pre class='hljl'>
<span class='hljl-nf'>randomchildnaive</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-n'>Tree</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplitnaive</span><span class='hljl-p'>(</span><span class='hljl-n'>identity</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span>
</pre>




<pre class='hljl'>
<span class='hljl-p'>[</span><span class='hljl-nf'>randomchildnaive</span><span class='hljl-p'>(</span><span class='hljl-n'>tlarge</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>_</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-ni'>10</span><span class='hljl-p'>]</span>
</pre>


<pre class="hljl">
10-element Array&#123;Main.WeaveSandBox2.Tree&#123;4&#125;,1&#125;:
 Branch&#40;
  Leaf&#40;1&#41;,
  Branch&#40;
    Branch&#40;
      Leaf&#40;4&#41;,
      Leaf&#40;3&#41;&#41;,
    Branch&#40;
      Branch&#40;
        Branch&#40;
          Leaf&#40;2&#41;,
          Leaf&#40;2&#41;&#41;,
        Leaf&#40;2&#41;&#41;,
      Leaf&#40;3&#41;&#41;&#41;&#41;
 Leaf&#40;4&#41;                                                                   
                                                                           
                                      
 Leaf&#40;2&#41;                                                                   
                                                                           
                                      
 Branch&#40;
  Leaf&#40;2&#41;,
  Leaf&#40;2&#41;&#41;                                                                 
                                                                           
                  
 Leaf&#40;3&#41;                                                                   
                                                                           
                                      
 Leaf&#40;4&#41;                                                                   
                                                                           
                                      
 Leaf&#40;3&#41;                                                                   
                                                                           
                                      
 Branch&#40;
  Leaf&#40;2&#41;,
  Leaf&#40;2&#41;&#41;                                                                 
                                                                           
                  
 Branch&#40;
  Branch&#40;
    Leaf&#40;2&#41;,
    Leaf&#40;2&#41;&#41;,
  Leaf&#40;2&#41;&#41;                                                                 
                                                                   
 Leaf&#40;2&#41;
</pre>


<p>To test for a uniform distribution of splits, we use some hackish “hashing” by summation: we sum the the labels of the tree, and based on that, create a histogram of the resulting numbers:</p>


<pre class='hljl'>
<span class='hljl-nf'>sumtree</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-n'>Leaf</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-oB'>.</span><span class='hljl-n'>label</span><span class='hljl-t'>
</span><span class='hljl-nf'>sumtree</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-n'>Branch</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>sumtree</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>.</span><span class='hljl-n'>left</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>sumtree</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>.</span><span class='hljl-n'>right</span><span class='hljl-p'>)</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>testvalues_native</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>zd</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>sumtree</span><span class='hljl-p'>(</span><span class='hljl-nf'>randomchildnaive</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>_</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-n'>N</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-p'>[(</span><span class='hljl-n'>i</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-n'>zd</span><span class='hljl-t'> </span><span class='hljl-oB'>.==</span><span class='hljl-t'> </span><span class='hljl-n'>i</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>i</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-nf'>unique</span><span class='hljl-p'>(</span><span class='hljl-n'>zd</span><span class='hljl-p'>)]</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="hljl">
testvalues_native &#40;generic function with 1 method&#41;
</pre>



<pre class='hljl'>
<span class='hljl-nf'>testvalues_native</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1000</span><span class='hljl-p'>)</span>
</pre>


<pre class="hljl">
5-element Array&#123;Tuple&#123;Int64,Int64&#125;,1&#125;:
 &#40;2, 203&#41;
 &#40;3, 188&#41;
 &#40;1, 195&#41;
 &#40;4, 183&#41;
 &#40;7, 231&#41;
</pre>


<p>As can be seen, the distribution is pretty uniform.</p>
<h2>Optimizing the implementation</h2>
<h3>Diagnose</h3>
<p>The above works reasonably well, but it has a performance problem, which you can see if you run the following &#40;where we compare to the final variant&#41;:</p>
<pre><code class="language-&#123;eval &#61; false; tangle &#61; false&#125;">julia&gt; @btime randomchildnaive&#40;&#36;&#40;rand&#40;BoltzmannSampler&#123;5&#125;&#40;1000, 1100&#41;&#41;&#41;&#41;;
  970.278 μs &#40;3318 allocations: 84.02 KiB&#41;
  
julia&gt; @btime randomchild&#40;&#36;&#40;rand&#40;BoltzmannSampler&#123;5&#125;&#40;1000, 1100&#41;&#41;&#41;&#41;;
  25.717 μs &#40;2136 allocations: 66.75 KiB&#41;</code></pre>
<p>In Julia versions below 1.0, this was even more extreme.  The problem is that we recurlively call anonymous functions of different type structure, which leads to compilation of extremely nested types.  We can see this when we look at an example from the stack trace of an interrupted execution:</p>
<pre><code class="language-&#123;eval &#61; false; tangle &#61; false&#125;">Stacktrace:
 &#91;1&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87 &#40;repeats 2 times&#41;
 &#91;2&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:91 &#40;repeats 2 times&#41;
 &#91;3&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87 &#40;repeats 3 times&#41;
 &#91;4&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:91 &#40;repeats 2 times&#41;
 &#91;5&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87 &#40;repeats 2 times&#41;
 &#91;6&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:91 &#40;repeats 2 times&#41;
 &#91;7&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87
 &#91;8&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:91
 &#91;9&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87
 &#91;10&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:91 &#40;repeats 2 times&#41;
 &#91;11&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87
 &#91;12&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:91 &#40;repeats 2 times&#41;
 &#91;13&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87
 &#91;14&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:91 &#40;repeats 2 times&#41;
 &#91;15&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87 &#40;repeats 2 times&#41;
 &#91;16&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##10#13&quot;&#41;&#41;&#123;Branch&#123;50&#125;,getfield&#40;Main, Symbol&#40;&quot;##9#12&quot;&#41;&#41;&#123;Branch&#123;50&#125;,typeof&#40;identity&#41;&#125;&#125;&#125;&#125;, ::Function&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:91 &#40;repeats 4 times&#41;
 &#91;17&#93; randomsplitnaive_impl&#40;::Branch&#123;50&#125;, ::Int64, ::typeof&#40;identity&#41;, ::Nothing&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:87
 &#91;18&#93; randomsplitnaive&#40;::Function, ::Branch&#123;50&#125;&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:113
 &#91;19&#93; randomchildnaive&#40;::Branch&#123;50&#125;&#41; at /home/philipp/git/TreeSplitting/src/TreeSplitting.jl:118
 &#91;20&#93; top-level scope at none:0</code></pre>
<h3>Solution</h3>
<p>To remove these issues, we should note that the source of the problem are the “unstable” types of the arguments <code>context</code> and <code>continuation</code> of the <code>randomsplitnaive_impl</code> function.  They result in being built up of nested closures, for which at every recursion level, a new type is inferred.</p>
<p>To solve this, we should realize that the used anonymous functions are of a very simple and repeating structure.  For <code>context</code>s, there are the following options:</p>



<pre class='hljl'>
<span class='hljl-n'>t</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-oB'>.</span><span class='hljl-n'>right</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>t</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-oB'>.</span><span class='hljl-n'>left</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>))</span>
</pre>


<p>while <code>continuation</code>s always have the structure</p>



<pre class='hljl'>
<span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-nf'>k</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-p'>)</span>
</pre>


<p>Looking at these closures, we can factor out the relevant information into their own types:</p>


<pre class='hljl'>
<span class='hljl-cs'># Context types:</span><span class='hljl-t'>
</span><span class='hljl-k'>abstract type</span><span class='hljl-t'> </span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>LeftContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;:</span><span class='hljl-t'> </span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>right</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>parent</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>RightContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;:</span><span class='hljl-t'> </span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>left</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>parent</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-cs'># This will be used instead of `nothing` in the top-level call</span><span class='hljl-t'>
</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>NoContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;:</span><span class='hljl-t'> </span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-k'>end</span><span class='hljl-t'>


</span><span class='hljl-cs'># Continuation type:</span><span class='hljl-t'>
</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>Cont</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>chunk</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>Now we can see that <code>Context</code> is actually just a <a href="https://wiki.haskell.org/Zipper">zipper</a> for the <code>Tree</code> type. </p>
<p>Then we just have to overload the calling operators of these types to make them work like the anonymous functionsa above:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-nf'>RightContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'>
    </span><span class='hljl-n'>context</span><span class='hljl-oB'>.</span><span class='hljl-nf'>parent</span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>.</span><span class='hljl-n'>left</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-nf'>LeftContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'>
    </span><span class='hljl-n'>context</span><span class='hljl-oB'>.</span><span class='hljl-nf'>parent</span><span class='hljl-p'>(</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>context</span><span class='hljl-oB'>.</span><span class='hljl-n'>right</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-nf'>NoContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'>
    </span><span class='hljl-n'>t</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>continuation</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Cont</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})(</span><span class='hljl-n'>k</span><span class='hljl-oB'>::</span><span class='hljl-n'>Function</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'>
    </span><span class='hljl-n'>newchunk</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>k</span><span class='hljl-p'>(</span><span class='hljl-n'>continuation</span><span class='hljl-oB'>.</span><span class='hljl-n'>chunk</span><span class='hljl-p'>)</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>tree</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-oB'>.</span><span class='hljl-nf'>context</span><span class='hljl-p'>(</span><span class='hljl-n'>newchunk</span><span class='hljl-p'>)</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>tree</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-oB'>.</span><span class='hljl-n'>chunk</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>Given this, it is easy, to rewrite <code>randomsplitnaive</code> in a more type-stable form as follows – in fact, this it results in simpler code:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplit_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Leaf</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>},</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-oB'>::</span><span class='hljl-n'>Int</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>},</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Cont</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>+=</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'>
    </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-oB'>≤</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-n'>n</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>Cont</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}(</span><span class='hljl-n'>context</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'>
    </span><span class='hljl-k'>else</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplit_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Branch</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>},</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-oB'>::</span><span class='hljl-n'>Int</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Context</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>},</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Cont</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>c1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplit_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>.</span><span class='hljl-n'>left</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>LeftContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}(</span><span class='hljl-n'>t</span><span class='hljl-oB'>.</span><span class='hljl-n'>right</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>context</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>continuation</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>c2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplit_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>.</span><span class='hljl-n'>right</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>RightContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}(</span><span class='hljl-n'>t</span><span class='hljl-oB'>.</span><span class='hljl-n'>left</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>context</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>c1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    
    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>+=</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'>
    </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-oB'>≤</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-n'>n</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>Cont</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}(</span><span class='hljl-n'>context</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'>
    </span><span class='hljl-k'>else</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>c2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplit</span><span class='hljl-p'>(</span><span class='hljl-n'>action</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>default_context</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>NoContext</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}()</span><span class='hljl-t'>
    </span><span class='hljl-n'>cont</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>_</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplit_impl</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>default_context</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>Cont</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}(</span><span class='hljl-n'>default_context</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-nf'>cont</span><span class='hljl-p'>(</span><span class='hljl-n'>action</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-nf'>randomchild</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-oB'>::</span><span class='hljl-nf'>Tree</span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>})</span><span class='hljl-t'> </span><span class='hljl-n'>where</span><span class='hljl-t'> </span><span class='hljl-p'>{</span><span class='hljl-n'>N</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randomsplit</span><span class='hljl-p'>(</span><span class='hljl-n'>identity</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span>
</pre>



<p>Again, we can test whether the random children are distributed about uniformly:</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>testvalues</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>zd</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>sumtree</span><span class='hljl-p'>(</span><span class='hljl-nf'>randomchild</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>_</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-n'>N</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-p'>[(</span><span class='hljl-n'>i</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-n'>zd</span><span class='hljl-t'> </span><span class='hljl-oB'>.==</span><span class='hljl-t'> </span><span class='hljl-n'>i</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>i</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-nf'>unique</span><span class='hljl-p'>(</span><span class='hljl-n'>zd</span><span class='hljl-p'>)]</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="hljl">
testvalues &#40;generic function with 1 method&#41;
</pre>



<pre class='hljl'>
<span class='hljl-nf'>testvalues</span><span class='hljl-p'>(</span><span class='hljl-n'>t</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1000</span><span class='hljl-p'>)</span>
</pre>


<pre class="hljl">
5-element Array&#123;Tuple&#123;Int64,Int64&#125;,1&#125;:
 &#40;7, 179&#41;
 &#40;2, 211&#41;
 &#40;3, 212&#41;
 &#40;4, 201&#41;
 &#40;1, 197&#41;
</pre>




          <HR/>
          <div class="footer"><p>
          Published from <a href="TreeSplitting.jmd">TreeSplitting.jmd</a> using
          <a href="http://github.com/mpastell/Weave.jl">Weave.jl</a>
           on 2018-10-04.
          <p></div>


        </div>
      </div>
    </div>
  </BODY>
</HTML>
